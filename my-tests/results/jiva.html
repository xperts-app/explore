<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Result</title>
  <style>
    body { font-family: 'Poppins', sans-serif; background: #f8f9fa; padding: 20px; }
    .container { max-width: 500px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    h2 { margin-bottom: 15px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Test Result</h2>
    <div id="resultBox">Loading...</div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD-ers6CRuH8bCFomXJHuLxPWff-Xa4ZVk",
      authDomain: "xperts-data.firebaseapp.com",
      projectId: "xperts-data",
      storageBucket: "xperts-data.appspot.com",
      messagingSenderId: "934675149024",
      appId: "1:934675149024:web:23486a5f38f65f103ce085",
      measurementId: "G-6TS06NTDZQ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const testId = urlParams.get("testId");

    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        let student = JSON.parse(localStorage.getItem("user"));
        if (!student) {
          const doc = await db.collection("users").doc(user.uid).get();
          if (doc.exists) {
            student = { id: user.uid, ...doc.data() };
            localStorage.setItem("user", JSON.stringify(student));
          }
        }
        if (!student || student.role !== "Student") {
          window.location.href = "1.html";
          return;
        }
        loadResult(student);
      } else {
        window.location.href = "1.html";
      }
    });

    async function loadResult(student) {
      const resultBox = document.getElementById("resultBox");
      try {
        const doc = await db.collection("results")
          .where("studentId", "==", student.id)
          .where("testId", "==", testId)
          .get();

        if (doc.empty) {
          resultBox.innerHTML = "No result found.";
          return;
        }

        doc.forEach(d => {
          const data = d.data();
          resultBox.innerHTML = `
            <p><strong>Score:</strong> ${data.score}</p>
            <p><strong>Status:</strong> ${data.status}</p>
          `;
        });
      } catch (err) {
        resultBox.innerHTML = "Error loading result.";
      }
    }
  </script>
</body>
</html>
