<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-blue: #0066ff; --background-color: #f0f4f9; --text-dark: #1d2c3c; --text-light: #5a6b7d; --card-bg: #ffffff; --border-color: #e0e6ed; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--background-color); margin: 0; padding: 20px; color: var(--text-dark); }
        .container { display: none; max-width: 800px; margin: auto; background-color: var(--card-bg); padding: 30px; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.05); }
        h1 { font-size: 24px; margin-bottom: 30px; text-align: center; }
        .form-section { margin-bottom: 25px; border-bottom: 1px solid var(--border-color); padding-bottom: 25px; }
        .form-section:last-child { border-bottom: none; padding-bottom: 0; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 500; margin-bottom: 8px; font-size: 14px; }
        input[type="text"], input[type="date"], input[type="number"], select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        .btn { background-color: var(--primary-blue); color: #fff; border: none; padding: 14px 20px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; }
        #students-container { display: none; }
        .student-entry { display: grid; grid-template-columns: 1fr 150px 100px; gap: 15px; align-items: center; padding: 15px; border-radius: 8px; background-color: #f8f9fa; margin-bottom: 10px; }
        p#loading-message { text-align: center; font-size: 18px; color: var(--text-light); }
    </style>
</head>
<body>
    <p id="loading-message">Verifying access...</p>
    <div class="container" id="admin-container">
        <h1>Create New Test</h1>
        <div class="form-section">
            <h2>1. Test Details</h2>
            <div class="form-group"><label for="testName">Test Name</label><input type="text" id="testName" placeholder="e.g., MINOR TEST 01"></div>
            <div class="form-group"><label for="testDate">Test Date</label><input type="date" id="testDate"></div>
            <div class="form-group"><label for="testMode">Mode of Test</label><select id="testMode"><option value="Online">Online</option><option value="Offline">Offline</option></select></div>
            <div class="form-group"><label for="testPattern">Test Pattern</label><input type="text" id="testPattern" placeholder="e.g., PNCF"></div>
            <div class="form-group"><label for="testClass">Select Class</label><select id="testClass"><option value="">-- Select a Class --</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11 JEE+NEET">11 JEE+NEET</option><option value="12 JEE+NEET">12 JEE+NEET</option></select></div>
        </div>
        <div class="form-section"><button id="fetchStudentsBtn" class="btn">Fetch Students</button></div>
        <div class="form-section" id="students-container">
            <h2>2. Enter Student Marks</h2>
            <div id="student-marks-list"></div>
            <button id="saveTestBtn" class="btn">Save Test Results</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyD-ers6CRuH8bCFomXJHuLxPWff-Xa4ZVk", authDomain: "xperts-data.firebaseapp.com", projectId: "xperts-data", storageBucket: "xperts-data.appspot.com", messagingSenderId: "934675149024", appId: "1:934675149024:web:23486a5f38f65f103ce085" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {
            const userRole = localStorage.getItem('loggedInUserRole');
            if (userRole !== 'Admin') {
                window.location.href = 'index.html';
                return;
            }
            document.getElementById('loading-message').style.display = 'none';
            document.getElementById('admin-container').style.display = 'block';
        });

        const fetchStudentsBtn = document.getElementById('fetchStudentsBtn');
        fetchStudentsBtn.addEventListener('click', async () => {
            const selectedClass = document.getElementById('testClass').value;
            if (!selectedClass) { alert('Please select a class first.'); return; }
            
            const studentsContainer = document.getElementById('students-container');
            const studentMarksList = document.getElementById('student-marks-list');
            fetchStudentsBtn.textContent = 'Fetching...';
            studentMarksList.innerHTML = 'Loading students...';
            studentsContainer.style.display = 'block';
            
            try {
                let query;
                if (selectedClass === '11 JEE+NEET') query = db.collection('users').where('class', 'in', ['11 JEE', '11 NEET']);
                else if (selectedClass === '12 JEE+NEET') query = db.collection('users').where('class', 'in', ['12 JEE', '12 NEET']);
                else query = db.collection('users').where('class', '==', selectedClass);
                
                const snapshot = await query.where('role', '==', 'Student').get();
                studentMarksList.innerHTML = '';
                if (snapshot.empty) { studentMarksList.innerHTML = '<p>No students found.</p>'; return; }

                snapshot.forEach(doc => {
                    studentMarksList.innerHTML += `<div class="student-entry" data-id="${doc.id}"><strong>${doc.data().fullName}</strong><input type="number" class="total-mark" placeholder="Total Marks"><label><input type="checkbox" class="absent-check"> Absent</label></div>`;
                });
                document.querySelectorAll('.absent-check').forEach(cb => cb.addEventListener('change', e => e.target.closest('.student-entry').querySelector('.total-mark').disabled = e.target.checked));
            } catch (error) { console.error(error); studentMarksList.innerHTML = '<p>Error loading students.</p>'; }
            finally { fetchStudentsBtn.textContent = 'Fetch Students'; }
        });

        document.getElementById('saveTestBtn').addEventListener('click', async () => {
            const saveBtn = document.getElementById('saveTestBtn');
            saveBtn.textContent = 'Saving...';
            try {
                const testData = {
                    testName: document.getElementById('testName').value, testDate: document.getElementById('testDate').value,
                    mode: document.getElementById('testMode').value, pattern: document.getElementById('testPattern').value,
                    class: document.getElementById('testClass').value, results: {}, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                if(!testData.testName || !testData.testDate || !testData.class){ alert('Please fill all test details.'); return; }
                
                let studentAppeared = 0;
                document.querySelectorAll('.student-entry').forEach(entry => {
                    const isAbsent = entry.querySelector('.absent-check').checked;
                    if (!isAbsent) studentAppeared++;
                    testData.results[entry.dataset.id] = {
                        totalMarks: isAbsent ? 0 : (parseFloat(entry.querySelector('.total-mark').value) || 0),
                        status: isAbsent ? 'Absent' : 'Present'
                    };
                });
                testData.studentAppear = studentAppeared;
                await db.collection('tests').add(testData);
                alert('Test saved successfully!');
                document.getElementById('students-container').style.display = 'none'; // Hide after saving
            } catch (error) { console.error(error); alert('Error saving test.'); }
            finally { saveBtn.textContent = 'Save Test Results'; }
        });
    </script>
</body>
</html>
