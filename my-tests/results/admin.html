<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal - Xperts</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-blue: #0066ff; --background-color: #f0f4f9; --text-dark: #1d2c3c; --text-light: #5a6b7d; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--background-color); margin: 0; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--background-color); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(0, 102, 255, 0.2); border-top-color: var(--primary-blue); border-radius: 50%; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .main-container { display: none; max-width: 450px; margin: auto; padding: 5vh 20px 20px 20px; text-align: center; }
        h2{font-weight:600;font-size:28px;color:var(--text-dark);margin-bottom:12px}p.subtitle{color:var(--text-light);font-size:16px;margin-bottom:40px;line-height:1.6}.input-group{margin-bottom:25px;text-align:left}label{display:block;margin-bottom:8px;font-weight:500;font-size:14px;color:var(--text-dark)}input{width:100%;padding:15px;border:1px solid #dbe2ea;border-radius:12px;font-size:16px;box-sizing:border-box;font-family:'Poppins',sans-serif;}input:focus{outline:0;border-color:var(--primary-blue);box-shadow:0 0 0 4px rgba(0,102,255,.1)}.btn-primary{background-color:var(--primary-blue);color:#fff;border:none;padding:16px 0;border-radius:12px;font-size:18px;font-weight:600;width:100%;cursor:pointer;}.btn-primary:disabled{background-color:#a0cffd;cursor:not-allowed}#password-container{display:none}.error-msg{color:#dc3545;font-weight:500;margin-top:20px;min-height:1.2em}
    </style>
</head>
<body>
    <div id="loading-overlay"><div class="spinner"></div></div>
    <div class="main-container" id="login-container">
        <h2>Student Portal</h2>
        <p class="subtitle">Enter your mobile number to sign in and continue your learning journey.</p>
        <div id="login-form">
            <div class="input-group"><label for="mobile">Mobile Number</label><input type="tel" id="mobile" name="mobile" placeholder="10-digit mobile number" maxlength="10"></div>
            <div id="password-container"><div class="input-group"><label for="password">Password</label><input type="password" id="password" name="password" placeholder="Enter your password"></div></div>
            <button type="button" class="btn-primary" id="submit-btn">Continue</button><p id="error-message" class="error-msg"></p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyD-ers6CRuH8bCFomXJHuLxPWff-Xa4ZVk", authDomain: "xperts-data.firebaseapp.com", projectId: "xperts-data", storageBucket: "xperts-data.appspot.com", messagingSenderId: "934675149024", appId: "1:934675149024:web:23486a5f38f65f103ce085" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Check if a student is already logged in
        (function handleAuthFlow() {
            const userId = localStorage.getItem('loggedInUserId');
            const userRole = localStorage.getItem('loggedInUserRole');
            if (userId && userRole === 'Student') {
                window.location.replace('student.html');
            } else {
                localStorage.clear();
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('login-container').style.display = 'block';
            }
        })();

        const mobileInput = document.getElementById('mobile');
        const passwordContainer = document.getElementById('password-container');
        const passwordInput = document.getElementById('password');
        const submitBtn = document.getElementById('submit-btn');
        const errorMessage = document.getElementById('error-message');
        let userData = null;

        submitBtn.addEventListener('click', async () => {
            submitBtn.disabled = true; submitBtn.textContent = 'Verifying...'; errorMessage.textContent = '';
            
            // Step 1: Find user by mobile number
            if (!userData) {
                try {
                    const snapshot = await db.collection('users').where('mobileNumber', '==', mobileInput.value.trim()).get();
                    if (snapshot.empty) {
                        errorMessage.textContent = 'No student account found with this mobile number.';
                        submitBtn.disabled = false; submitBtn.textContent = 'Continue';
                        return;
                    }
                    const userDoc = snapshot.docs[0];
                    userData = { id: userDoc.id, ...userDoc.data() };

                    if (userData.role !== 'Student') {
                         errorMessage.textContent = 'This portal is for students only.';
                         userData = null; // Reset user data
                         submitBtn.disabled = false; submitBtn.textContent = 'Continue';
                         return;
                    }
                    
                    passwordContainer.style.display = 'block';
                    passwordInput.focus();
                    submitBtn.textContent = 'Sign In';
                } catch (error) {
                    errorMessage.textContent = 'An error occurred. Please try again.';
                } finally {
                    submitBtn.disabled = false;
                }
            } 
            // Step 2: Verify password
            else {
                if (userData.password === passwordInput.value) {
                    localStorage.setItem('loggedInUserId', userData.id);
                    localStorage.setItem('loggedInUserRole', userData.role);
                    window.location.replace('student.html');
                } else {
                    errorMessage.textContent = 'Incorrect password. Please try again.';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Sign In';
                }
            }
        });
    </script>
</body>
</html>
